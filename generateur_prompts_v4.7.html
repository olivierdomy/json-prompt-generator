<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rateur de Prompts ‚Äì v4.7</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 16px; padding: 10px 15px; border: none; background: #0057a3; color: white; cursor: pointer; }
    h1 { margin-top: 0; }
    h2 { border-bottom: 1px solid #ccc; padding-bottom: 6px; margin-top: 26px; }
    .instruction { border-left: 5px solid #0057a3; margin-top: 15px; padding-left: 10px; background: #fdfdfd; padding: 10px; border-radius: 5px; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    .muted { color: #666; font-size: 12px; }
    .inline { display: inline-block; width: auto; vertical-align: middle; margin-right: 8px; }
    .hidden { display: none; }
    .small { font-size: 12px; }
    .panel { background: #fff; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
    pre { white-space: pre-wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 12px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h1>G√©n√©rateur de Prompts ‚Äì v4.7</h1>
<form id="promptForm">

  <h2>Comportement de l‚ÄôIA</h2>
  <div class="instruction">
    <label for="reasoningLevel">Niveau de raisonnement :</label>
    <select id="reasoningLevel">
      <option value=""></option>
      <option value="Automatique">Automatique ‚Äì Analyse simple des faits</option>
      <option value="Rapide">Rapide ‚Äì Traitement direct</option>
      <option value="√âlev√©">√âlev√© ‚Äì Logique structur√©e</option>
      <option value="Expert (multi-√©tapes)">Expert (multi-√©tapes)</option>
    </select>

    <label for="factuality">Fiabilit√© des donn√©es :</label>
    <select id="factuality">
      <option value=""></option>
      <option value="Cr√©atif (peut inventer)">Cr√©atif (peut inventer)</option>
      <option value="Interm√©diaire">Interm√©diaire</option>
      <option value="Raisonn√© (aucune donn√©e non v√©rifi√©e)">Raisonn√© (aucune donn√©e non v√©rifi√©e)</option>
      <option value="Strictement factuel">Strictement factuel</option>
    </select>

    <label for="compliance">Rigueur de conformit√© :</label>
    <select id="compliance">
      <option value=""></option>
      <option value="Cr√©atif">Cr√©atif</option>
      <option value="V√©rification l√©g√®re">V√©rification l√©g√®re</option>
      <option value="Contr√¥le par r√®gles">Contr√¥le par r√®gles</option>
      <option value="Sans compromis r√©glementaire">Sans compromis r√©glementaire</option>
    </select>

    <label for="depth">Profondeur d‚Äôanalyse :</label>
    <select id="depth">
      <option value=""></option>
      <option value="Superficielle">Superficielle</option>
      <option value="Standard">Standard</option>
      <option value="Approfondie">Approfondie</option>
      <option value="Exhaustive">Exhaustive</option>
    </select>

    <label for="autonomy">üîÅ Degr√© d‚Äôautonomie :</label>
    <select id="autonomy">
      <option value=""></option>
      <option value="Aucune (r√©pond uniquement sur faits)">Aucune</option>
      <option value="Faible (suggestions ponctuelles)">Faible</option>
      <option value="Mod√©r√©e (initie des propositions argument√©es)">Mod√©r√©e</option>
      <option value="Maximale (autoris√© √† reformuler)">Maximale</option>
    </select>

    <label for="reformulation">üß† Reformulation :</label>
    <select id="reformulation">
      <option value=""></option>
      <option value="Texte brut uniquement">Texte brut</option>
      <option value="Reformulation l√©g√®re (lisibilit√©)">L√©g√®re</option>
      <option value="Reformulation optimis√©e (impact, clart√©)">Optimis√©e</option>
      <option value="Libre (style √©ditorial)">Libre</option>
    </select>

    <label for="uncertainty">üß© Gestion des incertitudes :</label>
    <select id="uncertainty">
      <option value=""></option>
      <option value="Ne pas r√©pondre">Ne pas r√©pondre</option>
      <option value="√âmettre des hypoth√®ses (signal√©es)">Hypoth√®ses</option>
      <option value="Proposer des alternatives">Alternatives</option>
      <option value="Remonter des questions √† poser au client">Questions client</option>
    </select>
  </div>

  <h2>üìå M√©tadonn√©es</h2>
  <label>Nom du prompt :</label><input id="promptName" required>
  <label>#Objectif :</label><textarea id="mainObjective" rows="2" required></textarea>
  <label>#Contexte :</label><textarea id="context" rows="2"></textarea>
  <label>#R√¥le :</label><input id="globalRole">

  <h3>üñºÔ∏è Image par d√©faut</h3>
  <div class="row">
    <div class="col">
      <label>Concept (sc√®ne) :</label><input id="imageConcept" placeholder="ex: √©quipe AVV, robot assistant, √©cran de KPI">
    </div>
    <div class="col">
      <label>Style :</label>
      <select id="imageStyleKey">
        <option value=""></option>
        <option value="ligne_claire">Ligne claire (franco-belge)</option>
        <option value="flat">Flat illustration</option>
        <option value="isometrique">Isom√©trique vectoriel</option>
        <option value="lowpoly3d">3D low-poly</option>
        <option value="blueprint">Blueprint</option>
        <option value="doodle">Doodle / Whiteboard</option>
        <option value="photostudio">Photo r√©aliste soft-studio</option>
        <option value="pixelart">Pixel art</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <label>Fit :</label>
      <select id="imageFitSel">
        <option value="contain" selected>contain</option>
        <option value="cover">cover</option>
        <option value="fill">fill</option>
      </select>
    </div>
    <div class="col">
      <label>Fond :</label>
      <select id="imageBgSel">
        <option value="transparent" selected>Transparent</option>
        <option value="opaque">Opaque (blanc)</option>
      </select>
    </div>
    <div class="col">
      <label>Mode taille :</label>
      <select id="imageSizeMode">
        <option value="auto" selected>Auto depuis placeholder</option>
        <option value="custom">Personnalis√©e</option>
      </select>
    </div>
    <div class="col">
      <label>Largeur √ó Hauteur (px) :</label>
      <input id="imageSizeWH" placeholder="ex: 1212x942">
      <div class="small muted">Ignor√© si mode = Auto</div>
    </div>
  </div>
  <label class="inline"><input type="checkbox" id="imageNegStd" checked> N√©gatifs standard (pas de photo/grain/texte/logos/licences)</label>
  <label>Style libre (optionnel) :</label><input id="imageStyle" placeholder="ex: lignes nettes, aplats‚Ä¶">

  <h3>üß© Option PowerPoint</h3>
  <label class="inline"><input type="checkbox" id="enablePowerPoint"> Activer PowerPoint</label>
  <div id="pptOptions" class="panel hidden">
    <div class="row">
      <div class="col">
        <label>Layout par d√©faut (layout_id) :</label>
        <input id="defaultLayoutId" placeholder="ex: S03_TitleBodyPictureRight">
        <p class="muted small">Le fichier PPTX et le manifeste seront ajout√©s manuellement c√¥t√© IA.</p>
      </div>
    </div>

    <label>Manifeste (collez le JSON complet) :</label>
    <textarea id="manifestInput" rows="6" placeholder='{"template_manifest":{...}}'></textarea>
    <div class="row">
      <button type="button" id="parseManifestBtn">Analyser le manifeste</button>
    </div>
    <div id="manifestSummary" class="panel hidden">
      <div id="manifestInfo" class="small"></div>
    </div>
  </div>

  <h2>üìã Instructions</h2>
  <div id="instructionsContainer"></div>
  <button type="button" onclick="addInstruction()">+ Ajouter une instruction</button>
  <button type="submit">‚úÖ G√©n√©rer JSON</button>
  <button type="button" onclick="downloadJSON()">üì• T√©l√©charger JSON</button>
  <button type="button" onclick="downloadTXT()">üìÑ T√©l√©charger TXT</button>
</form>

<h2>üßæ Aper√ßu JSON</h2>
<pre id="jsonPreview"></pre>

<script>
// Presets
const STYLE_PRESETS = {
  ligne_claire: {
    label: "Ligne claire (franco-belge)",
    tags: ["ligne claire","aplats de couleurs","contours noirs nets","sans trame"],
    negative: "photo r√©aliste, grain, trame, watermark, texte, logos, personnages licenci√©s",
    style_hint: "Ligne claire franco-belge, aplats, contours noirs"
  },
  flat: {
    label: "Flat illustration",
    tags: ["flat illustration","formes g√©om√©triques","ombres longues l√©g√®res"],
    negative: "textures r√©alistes, photographique, watermark, texte, logos",
    style_hint: "Flat, aplats, ombres longues"
  },
  isometrique: {
    label: "Isom√©trique vectoriel",
    tags: ["isometric","vector","crisp edges","30¬∞ angle"],
    negative: "perspective r√©aliste, textures, photo, watermark, texte, logos",
    style_hint: "Isom√©trique vectoriel net"
  },
  lowpoly3d: {
    label: "3D low-poly",
    tags: ["clean CGI","low-poly","soft studio light","no texture"],
    negative: "photoreal noisy, detailed textures, watermark, texte, logos",
    style_hint: "3D low-poly studio clean"
  },
  blueprint: {
    label: "Blueprint",
    tags: ["blueprint","white lines on blue","technical diagram"],
    negative: "photo, textures papier, watermark, texte lisible, logos",
    style_hint: "Plan technique bleu"
  },
  doodle: {
    label: "Doodle / Whiteboard",
    tags: ["whiteboard","marker strokes","hand-drawn clean"],
    negative: "ombres r√©alistes, photo, watermark, texte lisible, logos",
    style_hint: "Tableau blanc feutre"
  },
  photostudio: {
    label: "Photo r√©aliste soft-studio",
    tags: ["soft studio light","clean background","realistic"],
    negative: "grain fort, watermark, texte, logos",
    style_hint: "Photo studio douce"
  },
  pixelart: {
    label: "Pixel art",
    tags: ["pixel art","8-bit","limited palette"],
    negative: "photo, d√©grad√©s lisses, watermark, texte, logos",
    style_hint: "Pixel art r√©tro"
  }
};

let instructionIndex = 0;
let latestJson = "";
let manifestData = null;

function $(id){ return document.getElementById(id); }
function show(el, visible){ el.classList.toggle('hidden', !visible); }

$('enablePowerPoint').addEventListener('change', () => {
  show($('pptOptions'), $('enablePowerPoint').checked);
  for (let i=1; i<=instructionIndex; i++){
    const pp = $('pptBlock'+i);
    if (pp) show(pp, $('enablePowerPoint').checked);
  }
});

$('parseManifestBtn').addEventListener('click', () => {
  try{
    const raw = $('manifestInput').value.trim();
    if(!raw){ manifestData = null; $('manifestInfo').innerHTML = '<em>Aucun manifeste fourni.</em>'; show($('manifestSummary'), true); return; }
    const obj = JSON.parse(raw);
    manifestData = obj.template_manifest ? obj : { template_manifest: obj };
    const tm = manifestData.template_manifest;
    let html = `<b>Fichier:</b> ${tm.file || '(non sp√©cifi√©)'} &nbsp; <b>Taille slide (in):</b> ${tm.slide_width_in || '?'} x ${tm.slide_height_in || '?'}<br>`;
    html += `<table><tr><th>Layout</th><th>Aliases</th><th>Placeholders (idx:type:name)</th></tr>`;
    for (const [lname, entry] of Object.entries(tm.layouts||{})){
      const al = entry.aliases || {};
      const aliasTxt = ['title','subtitle','body','picture'].map(k => {
        const v = al[k];
        if(!v) return `<span>${k}: -</span>`;
        const tn = typeof v.type === 'object' ? (v.type.name || '') : (v.type || '');
        return `<span>${k}: idx ${v.idx} (${tn})</span>`;
      }).join(' &nbsp; ');
      const phs = (entry.placeholders||[]).map(p => `${p.idx}:${(p.type && (p.type.name||p.type))||''}:${p.name||''}`).join(', ');
      html += `<tr><td>${lname}</td><td>${aliasTxt}</td><td class="small">${phs}</td></tr>`;
    }
    html += `</table>`;
    $('manifestInfo').innerHTML = html;
    show($('manifestSummary'), true);
    for (let i=1; i<=instructionIndex; i++){
      refreshLayoutOptions(i);
      refreshAliasHints(i);
    }
  }catch(e){
    alert("Manifeste invalide : " + e.message);
  }
});

function refreshLayoutOptions(i){
  const sel = $('layoutId'+i);
  if(!sel) return;
  const tm = manifestData && manifestData.template_manifest;
  const current = sel.value;
  sel.innerHTML = '';
  const optBlank = document.createElement('option'); optBlank.value=''; optBlank.textContent=''; sel.appendChild(optBlank);
  if (tm && tm.layouts){
    for (const lname of Object.keys(tm.layouts)){
      const o = document.createElement('option');
      o.value = lname; o.textContent = lname;
      sel.appendChild(o);
    }
  }
  sel.value = current;
}

function refreshAliasHints(i){
  const layoutSel = $('layoutId'+i);
  const lname = layoutSel && layoutSel.value ? layoutSel.value : ($('defaultLayoutId').value || '');
  const container = $('aliasHints'+i);
  if(!container) return;
  const tm = manifestData && manifestData.template_manifest;
  if(!(tm && tm.layouts && tm.layouts[lname])){
    container.innerHTML = '<span class="muted small">Alias indisponibles (s√©lectionnez un layout ou renseignez le manifeste).</span>';
    return;
  }
  const al = tm.layouts[lname].aliases || {};
  function aliasLine(key){
    const v = al[key];
    if(!v) return `${key}: -`;
    const tn = typeof v.type === 'object' ? (v.type.name || '') : (v.type || '');
    return `${key}: name="${v.name||''}" idx=${v.idx} type=${tn}`;
  }
  container.innerHTML = `<div class="small muted">${aliasLine('title')} | ${aliasLine('body')} | ${aliasLine('picture')}</div>`;
}

// Compute size from manifest + selected layout + picture target
function computeAutoSize(layoutName, picName, picAlias, picIdx){
  const tm = manifestData && manifestData.template_manifest;
  if(!(tm && tm.layouts && tm.layouts[layoutName])) return null;
  const entry = tm.layouts[layoutName];
  // by name
  let ph = (entry.placeholders||[]).find(p => p.name === picName);
  // by alias
  if(!ph && picAlias){
    const al = entry.aliases && entry.aliases[picAlias];
    if(al){
      ph = (entry.placeholders||[]).find(p => p.idx === al.idx);
    }
  }
  // by idx
  if(!ph && (picIdx || picIdx === 0)){
    ph = (entry.placeholders||[]).find(p => p.idx === picIdx);
  }
  if(!ph || !ph.bbox) return null;
  const wpx = Math.max(300, Math.round(parseFloat(ph.bbox.width_in) * 300));
  const hpx = Math.max(300, Math.round(parseFloat(ph.bbox.height_in) * 300));
  return `${wpx}x${hpx}`;
}

function addInstruction() {
  instructionIndex++;
  const c = $('instructionsContainer');
  const d = document.createElement('div');
  d.className = 'instruction';
  const i = instructionIndex;
  d.innerHTML = `
    <label>Action ${i} :</label><textarea id="action${i}"></textarea>
    <label>Format :</label><input id="format${i}">
    <label>Exemple :</label><textarea id="example${i}"></textarea>
    <label>V√©rifications :</label><textarea id="verif${i}"></textarea>
    <label class="inline"><input type="checkbox" class="generateImage" id="genImg${i}"> G√©n√©rer une image IA pour cette action</label>

    <div id="imgBlock${i}" class="panel hidden">
      <h4>üé® Image ‚Äì options de la s√©quence</h4>
      <div class="row">
        <div class="col">
          <label>Style (override) :</label>
          <select id="imgStyleKey${i}">
            <option value="">H√©riter des m√©tadonn√©es</option>
            <option value="ligne_claire">Ligne claire (franco-belge)</option>
            <option value="flat">Flat illustration</option>
            <option value="isometrique">Isom√©trique vectoriel</option>
            <option value="lowpoly3d">3D low-poly</option>
            <option value="blueprint">Blueprint</option>
            <option value="doodle">Doodle / Whiteboard</option>
            <option value="photostudio">Photo r√©aliste soft-studio</option>
            <option value="pixelart">Pixel art</option>
          </select>
        </div>
        <div class="col">
          <label>Fit (override) :</label>
          <select id="imgFit${i}">
            <option value="">H√©riter</option>
            <option value="contain">contain</option>
            <option value="cover">cover</option>
            <option value="fill">fill</option>
          </select>
        </div>
        <div class="col">
          <label>Fond (override) :</label>
          <select id="imgBg${i}">
            <option value="">H√©riter</option>
            <option value="transparent">Transparent</option>
            <option value="opaque">Opaque</option>
          </select>
        </div>
        <div class="col">
          <label>Mode taille :</label>
          <select id="imgSizeMode${i}">
            <option value="auto" selected>Auto depuis placeholder</option>
            <option value="custom">Personnalis√©e</option>
          </select>
        </div>
        <div class="col">
          <label>Largeur √ó Hauteur (px) :</label>
          <input id="imgSizeWH${i}" placeholder="ex: 1212x942">
          <div class="small muted">Ignor√© si Auto</div>
        </div>
      </div>
      <label>Prompt de sc√®ne :</label><textarea id="imgScene${i}" rows="2" placeholder="ex: √©quipe AVV, robot assistant..."></textarea>
      <label class="inline"><input type="checkbox" id="imgNegStd${i}" checked> N√©gatifs standard</label>
    </div>

    <div id="pptBlock${i}" class="${$('enablePowerPoint').checked ? '' : 'hidden'}">
      <h4>üß© PowerPoint ‚Äì options de la s√©quence</h4>
      <div class="row">
        <div class="col">
          <label>Layout sp√©cifique (optionnel) :</label>
          <select id="layoutId${i}"></select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Title ‚Üí placeholder_name :</label>
          <input id="phTitleName${i}" placeholder="ex: ph_title">
          <label class="small">Title ‚Üí alias :</label>
          <select id="phTitleAlias${i}">
            <option value=""></option>
            <option value="title">title</option>
          </select>
          <label class="small">Title ‚Üí idx :</label>
          <input id="phTitleIdx${i}" type="number" min="0" step="1">
        </div>
        <div class="col">
          <label>Body ‚Üí placeholder_name :</label>
          <input id="phBodyName${i}" placeholder="ex: ph_body">
          <label class="small">Body ‚Üí alias :</label>
          <select id="phBodyAlias${i}">
            <option value=""></option>
            <option value="body">body</option>
          </select>
          <label class="small">Body ‚Üí idx :</label>
          <input id="phBodyIdx${i}" type="number" min="0" step="1">
        </div>
        <div class="col">
          <label>Picture ‚Üí placeholder_name :</label>
          <input id="phPicName${i}" placeholder="ex: ph_picture">
          <label class="small">Picture ‚Üí alias :</label>
          <select id="phPicAlias${i}">
            <option value=""></option>
            <option value="picture">picture</option>
          </select>
          <label class="small">Picture ‚Üí idx :</label>
          <input id="phPicIdx${i}" type="number" min="0" step="1">
        </div>
      </div>
      <div id="aliasHints${i}" class="muted small" style="margin-top:6px;"></div>
    </div>
  `;
  c.appendChild(d);
  const chk = $('genImg'+i);
  chk.addEventListener('change', ()=>{ show($('imgBlock'+i), chk.checked); });
  refreshLayoutOptions(i);
  refreshAliasHints(i);
  const sel = $('layoutId'+i);
  if (sel) sel.addEventListener('change', () => refreshAliasHints(i));
}

// Assemble JSON
document.getElementById("promptForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const ai_profile = {
    reasoning_level: $('reasoningLevel').value,
    factuality: $('factuality').value,
    compliance: $('compliance').value,
    depth: $('depth').value,
    autonomy: $('autonomy').value,
    reformulation: $('reformulation').value,
    uncertainty: $('uncertainty').value
  };

  // Global image defaults
  const imgStyleKey = $('imageStyleKey').value;
  const preset = STYLE_PRESETS[imgStyleKey] || null;
  const imgFit = $('imageFitSel').value || "contain";
  const imgBg = $('imageBgSel').value || "transparent";
  const imgSizeMode = $('imageSizeMode').value || "auto";
  const imgSizeWH = $('imageSizeWH').value.trim();
  const metaImage = {
    concept: $('imageConcept').value,
    fit: imgFit,
    style_key: imgStyleKey || "",
    style_hint: (preset ? preset.style_hint : $('imageStyle').value) || "",
    background: imgBg,
    size_mode: imgSizeMode,
    default_size: imgSizeWH || "",
    negative_prompt_default: $('imageNegStd').checked ? (preset ? preset.negative : "photo r√©aliste, grain, watermark, texte, logos, personnages licenci√©s") : ""
  };

  const metadata = {
    prompt_name: $('promptName').value,
    objectifPrincipal: $('mainObjective').value,
    contexte: $('context').value,
    role: $('globalRole').value,
    image_policy: metaImage
  };

  const enablePP = $('enablePowerPoint').checked;
  const output = { ai_profile, metadata };

  if (enablePP){
    const template = {};
    const defaultLayoutId = $('defaultLayoutId').value.trim();
    if (defaultLayoutId) template.layout_id = defaultLayoutId;
    output.template = template;

    if (manifestData && manifestData.template_manifest){
      output.template_manifest = manifestData.template_manifest;
    }
  }

  const timeline = [];
  for (let i = 1; i <= instructionIndex; i++) {
    const seq = {
      sequence: i,
      action: $('action'+i)?.value || "",
      format: $('format'+i)?.value || "",
      exemple: $('example'+i)?.value || "",
      verifications: $('verif'+i)?.value || "",
      generate_image: !!document.getElementById('genImg'+i)?.checked
    };

    if (enablePP){
      const layoutVal = $('layoutId'+i)?.value || "";
      if (layoutVal) seq.layout_id = layoutVal;
      seq.targets = {
        title:   { placeholder_name: $('phTitleName'+i).value || "", alias: $('phTitleAlias'+i).value || "", idx: $('phTitleIdx'+i).value ? parseInt($('phTitleIdx'+i).value,10) : null },
        body:    { placeholder_name: $('phBodyName'+i).value || "",  alias: $('phBodyAlias'+i).value || "",  idx: $('phBodyIdx'+i).value ? parseInt($('phBodyIdx'+i).value,10) : null },
        picture: { placeholder_name: $('phPicName'+i).value || "",   alias: $('phPicAlias'+i).value || "",   idx: $('phPicIdx'+i).value ? parseInt($('phPicIdx'+i).value,10) : null }
      };
    }

    // Image object per sequence
    if (seq.generate_image){
      const styleKey = $('imgStyleKey'+i).value || imgStyleKey;
      const p = STYLE_PRESETS[styleKey] || preset || null;
      const fit = $('imgFit'+i).value || imgFit;
      const bg  = $('imgBg'+i).value || imgBg;
      const sizeMode = $('imgSizeMode'+i).value || imgSizeMode;
      let sizeWH = $('imgSizeWH'+i).value.trim();
      if (sizeMode === "auto" && enablePP){
        const lname = seq.layout_id || (output.template && output.template.layout_id) || "";
        const tpic = seq.targets ? seq.targets.picture : null;
        if (lname && tpic){
          const autoWH = computeAutoSize(lname, tpic.placeholder_name || "", tpic.alias || "picture", tpic.idx);
          if (autoWH) sizeWH = autoWH;
        }
      }
      const neg = document.getElementById('imgNegStd'+i).checked ? (p ? p.negative : (metaImage.negative_prompt_default || "")) : "";

      const scene = $('imgScene'+i).value || metadata.image_policy.concept || "";
      const styleTokens = p ? p.tags.join(", ") : (metadata.image_policy.style_hint || "");
      const prompt = [scene, styleTokens].filter(Boolean).join("; ");

      seq.image = {
        prompt,
        negative_prompt: neg,
        size: sizeWH || (imgSizeMode==="custom" ? metaImage.default_size : ""),
        fit: fit,
        transparent_background: (bg === "transparent"),
        style_key: styleKey || "",
        style_hint: p ? p.style_hint : (metadata.image_policy.style_hint || "")
      };
    }

    timeline.push(seq);
  }
  output.timeline = timeline;

  latestJson = JSON.stringify(output, null, 2);
  $('jsonPreview').textContent = latestJson;
});

function downloadJSON() {
  if (!latestJson) return alert("Rien √† sauvegarder.");
  const blob = new Blob([latestJson], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "prompt-" + new Date().toISOString().slice(0,10) + ".json";
  a.click();
}

function downloadTXT() {
  if (!latestJson) return alert("G√©n√®re d'abord un prompt.");
  const obj = JSON.parse(latestJson);
  let txt = `üéØ Objectif : ${obj.metadata.objectifPrincipal}\n`;
  txt += `üìÇ Contexte : ${obj.metadata.contexte}\n`;
  txt += `üë§ R√¥le : ${obj.metadata.role}\n`;
  const ip = obj.metadata.image_policy || {};
  txt += `üñºÔ∏è Image d√©faut : concept="${ip.concept||''}", style="${ip.style_key||ip.style_hint||''}", fit=${ip.fit||''}, bg=${ip.background||''}, size_mode=${ip.size_mode||''} ${ip.default_size?("("+ip.default_size+")"):""}\n`;

  txt += `ü§ñ Comportement IA :\n`;
  for (const [k, v] of Object.entries(obj.ai_profile)) {
    txt += `   - ${k} : ${v}\n`;
  }

  if (obj.template || obj.template_manifest){
    txt += `\nüìä PowerPoint :\n`;
    if (obj.template && obj.template.layout_id) txt += `   - Layout par d√©faut : ${obj.template.layout_id}\n`;
    if (obj.template_manifest){
      const tm = obj.template_manifest;
      txt += `   - Manifeste: ${tm.file || '(fichier non sp√©cifi√©)'}\n`;
      const layouts = Object.keys(tm.layouts||{});
      txt += `   - Layouts: ${layouts.join(', ')}\n`;
    }
  }

  txt += `\nüìã Instructions :\n`;
  for (const s of obj.timeline) {
    txt += `\nüîπ ${s.sequence}. ${s.action}\n`;
    txt += `   ‚û§ Format : ${s.format}\n`;
    txt += `   ‚û§ Exemple : ${s.exemple}\n`;
    txt += `   ‚û§ V√©rifications : ${s.verifications}\n`;
    txt += `   ‚û§ Image IA : ${s.generate_image ? "Oui" : "Non"}\n`;
    if (s.generate_image && s.image){
      const im = s.image;
      txt += `      ‚Ä¢ prompt="${im.prompt}"\n`;
      txt += `      ‚Ä¢ fit=${im.fit}, bg=${im.transparent_background?'transparent':'opaque'}, size=${im.size||'(auto)'}\n`;
      txt += `      ‚Ä¢ style=${im.style_key||im.style_hint||''}\n`;
      if (im.negative_prompt) txt += `      ‚Ä¢ n√©gatifs="${im.negative_prompt}"\n`;
    }
    if (s.layout_id || s.targets){
      txt += `   ‚û§ PPT:\n`;
      if (s.layout_id) txt += `      ‚Ä¢ layout_id : ${s.layout_id}\n`;
      if (s.targets){
        const t = s.targets;
        const line = (k,v)=>`      ‚Ä¢ ${k} ‚Üí name="${v.placeholder_name||''}" alias="${v.alias||''}" idx=${v.idx===null||v.idx===undefined?'':v.idx}\n`;
        txt += line('title', t.title);
        txt += line('body',  t.body);
        txt += line('picture', t.picture);
      }
    }
  }
  const blob = new Blob([txt], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "prompt-" + new Date().toISOString().slice(0,10) + ".txt";
  a.click();
}
</script>

</body>
</html>
